<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SynCronix</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* Estilos generales del cuerpo con gradiente personalizado */
        body {
            font-family: 'Inter', sans-serif;
            background: radial-gradient(circle at 75% 25%, 
                #020024 0%, 
                #090979 10%, 
                #0653aa 38%, 
                #00d4ff 100%);
            background-attachment: fixed;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
            position: relative;
            animation: gradientShift 15s ease infinite;
            background-size: 200% 200%;
        }

        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* Contenedor principal del chat con efecto vidrio */
        .chat-container {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.15);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            width: 100%;
            max-width: 500px;
            height: 80vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
            z-index: 1;
            transition: box-shadow 0.3s ease;
        }

        .chat-container:hover {
            box-shadow: 0 0 15px rgba(0, 212, 255, 0.5);
        }

        /* Encabezado del chat rediseñado */
        .chat-header {
            background: linear-gradient(90deg, 
                rgba(2, 0, 36, 0.8) 0%, 
                rgba(9, 9, 121, 0.8) 50%, 
                rgba(0, 212, 255, 0.4) 100%);
            color: white;
            padding: 15px 20px;
            font-size: 1.2em;
            font-weight: bold;
            border-top-left-radius: 15px;
            border-top-right-radius: 15px;
            border-bottom: 1px solid rgba(0, 212, 255, 0.3);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
        }

        .header-content {
            display: flex;
            align-items: center;
            justify-content: center;
            flex-grow: 1;
            position: absolute;
            left: 0;
            right: 0;
            top: 0;
            bottom: 0;
            z-index: 0;
        }

        .header-title {
            color: #ffffff; /* COLOR CAMBIADO A AZUL */
            text-shadow: 0 0 10px rgba(0, 212, 255, 0.5);
            font-size: 1.2em;
            font-weight: bold;
        }

        .chat-header button {
            background: none;
            border: none;
            color: white;
            font-size: 1.5em;
            cursor: pointer;
            padding: 5px 10px;
            border-radius: 5px;
            transition: background 0.2s ease;
            position: relative;
            z-index: 1;
        }

        .chat-header button:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        /* Cuerpo del chat (mensajes) */
        .chat-messages {
            flex-grow: 1;
            padding: 20px;
            overflow-y: auto;
            background-color: rgba(255, 255, 255, 0.05);
            scroll-behavior: smooth;
        }

        .message-bubble {
            display: flex;
            margin-bottom: 15px;
            align-items: flex-end;
        }

        .message-bubble.user {
            justify-content: flex-end;
        }

        .message-bubble.syncronix {
            justify-content: flex-start;
        }

        .message-bubble.info {
            justify-content: center;
            text-align: center;
        }

        .message-content {
            padding: 12px 18px;
            border-radius: 20px;
            max-width: 75%;
            position: relative;
            font-size: 0.95em;
            line-height: 1.4;
            word-wrap: break-word;
        }

        /* Burbujas de mensaje rediseñadas */
        .message-bubble.user .message-content {
            background: linear-gradient(135deg, #00d4ff 0%, #0653aa 100%);
            color: white;
            border-radius: 18px 18px 4px 18px;
            box-shadow: 0 4px 15px rgba(0, 212, 255, 0.3);
        }

        .message-bubble.syncronix .message-content {
            background: rgba(255, 255, 255, 0.95);
            color: #020024;
            border-radius: 18px 18px 18px 4px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .message-bubble.info .message-content {
            background-color: rgba(255, 255, 255, 0.2);
            color: white;
            font-size: 0.85em;
            border-radius: 10px;
            padding: 8px 15px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
        }

        /* ELIMINADO: .timestamp CSS rule */

        /* Indicador de escritura */
        .typing-indicator {
            display: flex;
            align-items: center;
            margin-top: 10px;
            margin-bottom: 15px;
            padding-left: 20px;
        }

        .typing-indicator span {
            height: 10px;
            width: 10px;
            background-color: #00d4ff;
            border-radius: 50%;
            margin: 0 3px;
            animation: bounce 0.6s infinite alternate;
            box-shadow: 0 0 5px #00d4ff;
        }

        .typing-indicator span:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-indicator span:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes bounce {
            to {
                transform: translateY(-5px);
                background-color: #0653aa;
            }
        }

        /* Pie de página del chat (entrada de usuario) - Estilo futurista */
        .chat-footer {
            display: flex;
            padding: 15px 20px;
            background: rgba(2, 0, 36, 0.7);
            border-top: 1px solid rgba(0, 212, 255, 0.2);
            backdrop-filter: blur(5px);
            border-bottom-left-radius: 15px;
            border-bottom-right-radius: 15px;
        }

        .chat-footer input[type="text"] {
            flex-grow: 1;
            padding: 12px 15px;
            background: rgba(255, 255, 255, 0.15);
            border: 1px solid rgba(0, 212, 255, 0.3);
            border-radius: 25px;
            outline: none;
            font-size: 1em;
            margin-right: 10px;
            transition: all 0.3s;
            color: white;
        }

        .chat-footer input[type="text"]::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }

        .chat-footer input[type="text"]:focus {
            border-color: #00d4ff;
            box-shadow: 0 0 0 2px rgba(0, 212, 255, 0.2);
        }

        .chat-footer button {
            background: linear-gradient(135deg, #00d4ff 0%, #0653aa 100%);
            color: white;
            border: none;
            border-radius: 25px;
            padding: 12px 20px;
            cursor: pointer;
            font-size: 1em;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            box-shadow: 0 2px 10px rgba(0, 212, 255, 0.4);
        }

        .chat-footer button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 212, 255, 0.6);
        }

        .chat-footer button:active {
            transform: scale(0.95);
        }

        /* Input de calendario (oculto por defecto) */
        #calendarInput {
            display: none;
            margin-top: 10px;
            padding: 8px;
            border: 1px solid rgba(0, 212, 255, 0.3);
            border-radius: 5px;
            width: calc(100% - 40px);
            margin-left: 20px;
            margin-right: 20px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }

        /* Botones de acción rápida */
        .quick-actions {
            position: fixed;
            bottom: 100px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 10;
        }
        
        .quick-actions button {
            padding: 10px 15px;
            border-radius: 25px;
            background: linear-gradient(135deg, #00d4ff 0%, #0653aa 100%);
            color: white;
            border: none;
            cursor: pointer;
            box-shadow: 0 2px 10px rgba(0, 212, 255, 0.4);
            font-size: 0.9em;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: all 0.3s ease;
        }

        .quick-actions button:hover {
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 5px 15px rgba(0, 212, 255, 0.6);
        }

        /* Modales con el nuevo estilo */
        .help-modal, .api-key-modal, .custom-alert-modal {
            display: none;
            position: fixed;
            z-index: 1001;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            align-items: flex-start; /* Cambiado de 'center' a 'flex-start' */
            justify-content: center;
            padding-top: 20px; /* Espacio en la parte superior */
            padding-bottom: 20px; /* Espacio en la parte inferior */
            overflow: auto; /* Permite scroll si es necesario */
        }

        .help-modal-content, .api-key-content, .custom-alert-content {
            background: rgba(2, 0, 36, 0.9);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(0, 212, 255, 0.3);
            padding: 20px; /* AJUSTADO: padding a 20px */
            border-radius: 15px;
            width: 90%;
            max-width: 500px; /* Mismo ancho que el chat principal */
            max-height: 80vh; /* 80% del viewport (similar al zoom 100%) */
            overflow-y: auto; /* Scroll vertical cuando sea necesario */
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            position: relative;
            animation: fadeIn 0.3s ease-out;
            color: white;
            /* Eliminado margin: 5vh auto; ya que padding-top/bottom y align-items: flex-start lo controlan */
        }

        .help-modal-content h2 {
            color: #00d4ff;
            margin-top: 0;
            margin-bottom: 15px; /* AJUSTADO: margin-bottom a 15px */
            text-align: center;
            font-size: 1.3em; /* Tamaño de fuente ligeramente reducido */
        }
        
        .help-modal-content h3 {
            color: white;
            margin-top: 15px; /* AJUSTADO: margin-top a 15px */
            margin-bottom: 8px; /* AJUSTADO: margin-bottom a 8px */
            border-bottom: 1px solid rgba(0, 212, 255, 0.3);
            padding-bottom: 5px;
            font-size: 1.1em; /* Tamaño de fuente ligeramente reducido */
        }

        .help-modal-content ul {
            list-style-type: none;
            padding: 0;
        }

        .help-modal-content ul li {
            margin-bottom: 8px; /* AJUSTADO: margin-bottom a 8px */
            font-size: 0.9em; /* AJUSTADO: font-size a 0.9em */
            line-height: 1.4;
            color: rgba(255, 255, 255, 0.8);
            padding: 8px 10px; /* AJUSTADO: padding a 8px 10px */
            background: rgba(0, 212, 255, 0.1);
            border-radius: 6px;
        }

        .help-modal-content ul li strong {
            color: #00d4ff;
        }

        .help-modal-content ul li a {
            color: #00d4ff;
            text-decoration: none;
            font-weight: bold;
        }

        .help-modal-content ul li a:hover {
            text-decoration: underline;
        }

        .close-button {
            color: rgba(255, 255, 255, 0.6);
            position: absolute;
            top: 15px;
            right: 25px;
            font-size: 30px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.2s;
        }

        .close-button:hover {
            color: #00d4ff;
        }

        /* Interruptor de tema oscuro */
        .theme-toggle {
            position: fixed;
            top: 20px;
            left: 20px;
            background: rgba(0, 212, 255, 0.2);
            border: 1px solid rgba(0, 212, 255, 0.4);
            color: white;
            border-radius: 20px;
            padding: 8px 15px;
            cursor: pointer;
            z-index: 100;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9em;
        }

        /* Estilos para el modal de API Key */
        .api-key-content h3 {
            color: #00d4ff;
            font-size: 1.3em;
            margin-bottom: 15px;
        }

        .api-key-content input {
            width: 100%;
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid rgba(0, 212, 255, 0.3);
            border-radius: 5px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            box-sizing: border-box;
        }

        .api-key-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .api-key-buttons button {
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .api-key-save {
            background: linear-gradient(135deg, #00d4ff 0%, #0653aa 100%);
            color: white;
            border: none;
        }

        .api-key-cancel {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(0, 212, 255, 0.3);
            color: white;
        }

        /* Estilos para el modal de alerta personalizado */
        .custom-alert-content h3 {
            color: #00d4ff;
            margin-top: 0;
            font-size: 1.4em;
            margin-bottom: 15px;
        }

        .custom-alert-content p {
            margin-bottom: 20px;
            color: rgba(255, 255, 255, 0.8);
            line-height: 1.5;
        }

        .custom-alert-content button {
            background: linear-gradient(135deg, #00d4ff 0%, #0653aa 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.3s ease;
        }

        .custom-alert-content button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 212, 255, 0.4);
        }

        /* Ajustes responsivos */
        @media (max-width: 768px) {
            .chat-container {
                height: 95vh;
                margin: 0;
                border-radius: 0;
                box-shadow: none;
            }
            
            body {
                padding: 0;
                background: radial-gradient(circle at center, 
                    #020024 0%, 
                    #090979 20%, 
                    #0653aa 60%);
            }
            
            .quick-actions {
                bottom: 80px;
                right: 10px;
            }
            
            .quick-actions button {
                padding: 8px 12px;
                font-size: 0.8em;
            }
        }

        /* Animaciones adicionales */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-50px); } /* Ajustado para un efecto de "caída" más sutil */
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes slideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
    </style>
</head>
<body>
    <!-- Interruptor de tema -->
    <button class="theme-toggle" id="themeToggle">
        <span>🌓</span> Cambiar tema
    </button>

    <div class="chat-container">
        <div class="chat-header">
            <div style="flex-basis: 50px;"></div>
            <div class="header-content">
                <!-- Aquí puedes añadir tu logo. Asegúrate de que la ruta sea correcta. -->
                <!-- Por ejemplo: <img src="ruta/a/tu/logo.png" alt="Logo SynCronix" class="header-logo"> -->
                <span class="header-title">SynCronix</span>
            </div>
            <button id="helpButton">?</button>
        </div>
        <div class="chat-messages" id="chatBox">
            <div class="typing-indicator" id="typingIndicator" style="display: none;">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </div>
        <input type="date" id="calendarInput">
        <div class="chat-footer">
            <input type="text" id="userInput" placeholder="Escribe tu mensaje...">
            <button id="sendButton">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M22 2L11 13" stroke="white" stroke-width="2" stroke-linecap="round"/>
                    <path d="M22 2L15 22L11 13L2 9L22 2Z" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            </button>
        </div>
    </div>

    <div class="quick-actions">
        <button id="quickTime"><span>🕒</span> Hora</button>
        <button id="quickDate"><span>📅</span> Fecha</button>
        <button id="quickTasks"><span>✅</span> Tareas</button>
        <button id="quickEvents"><span>📆</span> Eventos</button>
    </div>

    <!-- Modal de ayuda -->
    <div id="helpModal" class="help-modal">
        <div class="help-modal-content">
            <span class="close-button" id="closeHelpModal">&times;</span>
            <h2>¿Cómo puedo ayudarte?</h2>
            <h3>Gestión de Tiempo</h3>
            <ul id="commandListTime"></ul>
            <h3>Organización de Tareas y Proyectos</h3>
            <ul id="commandListTasks"></ul>
            <h3>Contactos Importantes</h3>
            <ul id="commandListContacts"></ul>
            <h3>Asistente de Investigación y Notas</h3>
            <ul id="commandListResearch"></ul>
            <h3>Información General y Conversación</h3>
            <ul id="commandListGeneral"></ul>
        </div>
    </div>

    <!-- Modal de API Key -->
    <div id="apiKeyModal" class="api-key-modal">
        <div class="api-key-content">
            <h3>Configurar API Key</h3>
            <p>Para usar todas las funciones, necesitas una clave API de Gemini.</p>
            <input type="password" id="apiKeyInput" placeholder="Ingresa tu clave API">
            <div class="api-key-buttons">
                <button id="apiKeyCancel" class="api-key-cancel">Cancelar</button>
                <button id="apiKeySave" class="api-key-save">Guardar</button>
            </div>
        </div>
    </div>

    <!-- Modal de Alerta -->
    <div id="customAlertModal" class="custom-alert-modal">
        <div class="custom-alert-content">
            <h3 id="customAlertTitle"></h3>
            <p id="customAlertMessage"></p>
            <button id="customAlertCloseButton">Entendido</button>
        </div>
    </div>

    <script>
        // --- 1. Funciones de Utilidad ---

        // Función para agregar mensajes al chat
        function appendMessage(sender, text) {
            const messageBubble = document.createElement('div');
            messageBubble.classList.add('message-bubble', sender);

            const messageContent = document.createElement('div');
            messageContent.classList.add('message-content');
            messageContent.innerHTML = text; // Permite HTML para negritas, etc.

            // ELIMINADO: Código para añadir el timestamp
            // const timestamp = document.createElement('span');
            // timestamp.classList.add('timestamp');
            // const now = new Date();
            // timestamp.textContent = now.toLocaleTimeString('es-VE', { hour: '2-digit', minute: '2-digit' });
            // messageBubble.appendChild(timestamp);

            messageBubble.appendChild(messageContent);
            chatBox.appendChild(messageBubble);
            chatBox.scrollTop = chatBox.scrollHeight; // Auto-scroll
        }

        // Función para mostrar el indicador de escritura
        function showTypingIndicator() {
            typingIndicator.style.display = 'flex';
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        // Función para ocultar el indicador de escritura
        function hideTypingIndicator() {
            typingIndicator.style.display = 'none';
        }

        // Función para mostrar una alerta personalizada
        function showAlert(title, message) {
            customAlertTitle.textContent = title;
            customAlertMessage.textContent = message;
            customAlertModal.style.display = 'flex';
        }

        // Reiniciar estados de flujo de conversación
        function resetStates() {
            currentAction = null;
            pendingDetail = null;
            tempEvent = { type: '', date: '', time: '', description: '' };
            tempTask = { id: null, description: '', completed: false, tags: [] }; // Añadimos tags
            tempContact = { name: '', phone: '', email: '' };
        }

        // Saludo inicial del chatbot
        function initialGreeting() {
            appendMessage('syncronix', '¡Hola! Soy SynCronix, tu asistente personal. ¿Cuál es tu nombre?');
            userInput.placeholder = "Escribe tu nombre aquí...";
        }

        // Función para manejar la consulta de hora y fecha
        function handleTimeAndDateQuery() {
            const now = new Date();
            const time = now.toLocaleTimeString('es-VE', { hour: '2-digit', minute: '2-digit' });
            const date = now.toLocaleDateString('es-VE', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            appendMessage('syncronix', `Son las ${time} del ${date}.`);
            resetStates();
        }

        // Función para manejar la consulta de creadores
        function handleCreatorsQuery() {
            appendMessage('syncronix', 'Fui creado por un equipo apasionado de desarrolladores con el objetivo de hacer tu vida más organizada y productiva.');
            resetStates();
        }

        // Función para manejar la consulta del nombre del bot
        function handleNameQuery() {
            appendMessage('syncronix', `Mi nombre es SynCronix. Estoy aquí para ayudarte a sincronizar y organizar tu vida.`);
            resetStates();
        }

        // Función para manejar saludos
        function handleGreeting() {
            const hour = new Date().getHours();
            let greeting = '¡Hola!';
            if (hour < 12) {
                greeting = '¡Buenos días!';
            } else if (hour < 19) {
                greeting = '¡Buenas tardes!';
            } else {
                greeting = '¡Buenas noches!';
            }
            appendMessage('syncronix', `${greeting} ${userName ? userName : 'Usuario'}! ¿Cómo puedo ayudarte hoy?`);
            resetStates();
        }

        // --- Manejo de Eventos (Reuniones, Alarmas, Recordatorios) ---

        // Inicia el flujo para agendar un evento
        function startScheduleEvent(type) {
            currentAction = type;
            tempEvent.type = type;
            appendMessage('syncronix', `Para tu ${type === 'meeting' ? 'reunión' : type === 'alarm' ? 'alarma' : 'recordatorio'}, ¿qué día será?`);
            showCalendar();
            pendingDetail = 'date';
        }

        // Maneja los detalles del evento (fecha, hora, descripción)
        function handleEventDetails(userText) {
            switch (pendingDetail) {
                case 'time':
                    const parsedTime = parseTime(userText);
                    if (parsedTime) {
                        tempEvent.time = parsedTime;
                        pendingDetail = 'description';
                        appendMessage('syncronix', 'Genial. Ahora, por favor, dame una breve descripción o título para este evento.');
                    } else {
                        appendMessage('syncronix', 'Ese formato de hora no es válido. Por favor, intenta de nuevo (ejemplo: "3 PM", "15:00", "once de la noche").');
                    }
                    break;
                case 'description':
                    tempEvent.description = userText;
                    scheduledEvents.push(tempEvent);
                    saveAllData();
                    appendMessage('syncronix', `¡Listo! Tu ${tempEvent.type === 'meeting' ? 'reunión' : tempEvent.type === 'alarm' ? 'Alarma' : 'recordatorio'} "${tempEvent.description}" ha sido agendada para el ${tempEvent.date} a las ${tempEvent.time}.`);
                    showAlert('Evento Agendado', `"${tempEvent.description}" el ${tempEvent.date} a las ${tempEvent.time}.`);
                    resetStates();
                    break;
            }
        }

        // Lista todos los eventos agendados
        function listScheduledEvents() {
            if (scheduledEvents.length === 0) {
                appendMessage('syncronix', 'No tienes eventos, alarmas o recordatorios agendados.');
                return;
            }

            let message = 'Aquí están tus eventos agendados:<ul>';
            scheduledEvents.forEach((event, index) => {
                message += `<li><strong>${index + 1}.</strong> ${event.type === 'meeting' ? 'Reunión' : event.type === 'alarm' ? 'Alarma' : 'Recordatorio'} "${event.description}" el ${event.date} a las ${event.time}.</li>`;
            });
            message += '</ul>';
            appendMessage('syncronix', message);
            resetStates();
        }
        
        // Inicia el flujo para cancelar un evento
        function startCancelEvent() {
            if (scheduledEvents.length === 0) {
                appendMessage('syncronix', 'No tienes eventos para cancelar.');
                resetStates();
                return;
            }
            let message = '¿Qué evento deseas cancelar? Por favor, dime el número o una descripción del evento:<ul>';
            scheduledEvents.forEach((event, index) => {
                message += `<li><strong>${index + 1}.</strong> ${event.type === 'meeting' ? 'Reunión' : event.type === 'alarm' ? 'Alarma' : 'Recordatorio'} "${event.description}" el ${event.date} a las ${event.time}.</li>`;
            });
            message += '</ul>';
            appendMessage('syncronix', message);
            currentAction = 'cancelEvent';
            pendingDetail = 'eventToCancel';
        }

        // Maneja la cancelación de un evento
        function handleCancelEvent(userText) {
            const index = parseInt(userText) - 1;
            let eventRemoved = null;

            if (!isNaN(index) && index >= 0 && index < scheduledEvents.length) {
                eventRemoved = scheduledEvents.splice(index, 1)[0];
            } else {
                const foundIndex = scheduledEvents.findIndex(event =>
                    event.description.toLowerCase().includes(userText.toLowerCase())
                );
                if (foundIndex !== -1) {
                    eventRemoved = scheduledEvents.splice(foundIndex, 1)[0];
                }
            }

            if (eventRemoved) {
                saveAllData();
                appendMessage('syncronix', `El evento "${eventRemoved.description}" ha sido cancelado.`);
                showAlert('Evento Cancelado', `"${eventRemoved.description}" ha sido removido.`);
            } else {
                appendMessage('syncronix', 'No pude encontrar ese evento. Por favor, intenta con el número o una descripción exacta.');
            }
            resetStates();
        }

        // Función para parsear la hora del usuario a formato HH:MM (24h)
        function parseTime(timeStr) {
            timeStr = timeStr.toLowerCase().replace(/\s/g, ''); // Limpiar espacios y a minúsculas

            // RegEx para "HH:MM (am/pm)", "HH am/pm", "HH:MM", "HH"
            let hour, minute, ampm;

            // Intenta capturar "HH:MM" con o sin am/pm
            let match = timeStr.match(/^(\d{1,2})(:(\d{2}))?(am|pm)?$/);
            if (match) {
                hour = parseInt(match[1]);
                minute = match[3] ? match[3] : '00';
                ampm = match[4];

                if (ampm) {
                    if (ampm === 'pm' && hour < 12) {
                        hour += 12;
                    } else if (ampm === 'am' && hour === 12) { // 12 AM (medianoche) es 00
                        hour = 0;
                    }
                }
                // Validar hora (0-23) y minuto (0-59)
                if (hour >= 0 && hour <= 23 && parseInt(minute) >= 0 && parseInt(minute) <= 59) {
                    return `${String(hour).padStart(2, '0')}:${String(minute).padStart(2, '0')}`;
                }
            }

            // RegEx para "diez de la mañana", "tres y media de la tarde", "once de la noche"
            const hourWords = {
                'una': 1, 'dos': 2, 'tres': 3, 'cuatro': 4, 'cinco': 5, 'seis': 6,
                'siete': 7, 'ocho': 8, 'nueve': 9, 'diez': 10, 'once': 11, 'doce': 12
            };
            const minuteWords = { 'ycuarto': 15, 'ymedia': 30, 'ymenoscarto': 45, 'enpunto': 0 };

            for (const wordHour in hourWords) {
                if (timeStr.includes(wordHour)) {
                    hour = hourWords[wordHour];
                    minute = '00';

                    for (const wordMinute in minuteWords) {
                        if (timeStr.includes(wordMinute)) {
                            minute = minuteWords[wordMinute].toString().padStart(2, '0');
                            break;
                        }
                    }

                    if (timeStr.includes('mañana') && hour === 12) { // 12 del mediodía
                         hour = 12;
                    } else if (timeStr.includes('mañana') && hour < 12) { // Cualquier otra hora AM
                        // No cambia
                    } else if ((timeStr.includes('tarde') || timeStr.includes('noche')) && hour < 12) {
                        hour += 12;
                    } else if (timeStr.includes('medianoche') && hour === 12) {
                        hour = 0; // 12 de la medianoche es 00:00
                    }

                    return `${String(hour).padStart(2, '0')}:${minute}`;
                }
            }
            return null; // Si no se puede parsear
        }

        // Muestra el input de calendario para la selección de fecha
        function showCalendar() {
            calendarInput.style.display = 'block';
            calendarInput.focus();
            calendarInput.value = '';
            calendarInput.onchange = function() {
                if (calendarInput.value) {
                    const selectedDate = new Date(calendarInput.value + 'T00:00:00');
                    tempEvent.date = selectedDate.toLocaleDateString('es-VE');
                    appendMessage('user', tempEvent.date);
                    calendarInput.style.display = 'none';
                    pendingDetail = 'time';
                    appendMessage('syncronix', 'Perfecto, ¿a qué hora? (ejemplo: "3 PM", "15:00" o "once de la noche") ');
                }
            };
        }

        // Llama a la API de Gemini para respuestas generales
        async function callGeminiAPI(prompt) {
            if (!apiKey) { // Si la API Key no está definida, mostrar el modal
                appendMessage('syncronix', 'Necesitas configurar una clave API para usar esta función. Por favor, ingresa tu clave API de Gemini.');
                showApiKeyModal();
                return;
            }

            showTypingIndicator();
            const chatHistory = [];
            chatHistory.push({ role: "user", parts: [{ text: prompt }] });
            const payload = { contents: chatHistory };
            
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                if (!response.ok) {
                    // Intenta parsear el error del cuerpo de la respuesta si está disponible
                    const errorBody = await response.json().catch(() => ({}));
                    const errorMessage = errorBody.error ? errorBody.error.message : `Error de red o servidor: ${response.status}`;
                    throw new Error(errorMessage);
                }
                
                const result = await response.json();

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const text = result.candidates[0].content.parts[0].text;
                    appendMessage('syncronix', text);
                } else {
                    // Mensaje más específico para el usuario si la API no devuelve contenido
                    appendMessage('syncronix', 'Lo siento, no pude generar una respuesta en este momento. Esto podría ser un problema con la respuesta de la IA. Por favor, intenta de nuevo más tarde.');
                }
            } catch (error) {
                console.error('Error al llamar a la API de Gemini:', error);
                let userFriendlyMessage = 'Hubo un problema al conectar con mi cerebro (la inteligencia artificial). Asegúrate de que tienes una conexión a internet.';
                
                // Errores específicos de la API Key
                if (error.message.includes('API key not valid') || error.message.includes('API key not found') || error.message.includes('401') || error.message.includes('403')) {
                    userFriendlyMessage = 'Parece que tu clave API de Gemini no es válida o no está configurada. Por favor, configúrala en el menú de ayuda (botón "?").';
                    showApiKeyModal(); // Mostrar el modal para que el usuario pueda corregirla
                } else if (error.message.includes('resource exhausted')) {
                    userFriendlyMessage = 'He recibido demasiadas peticiones recientemente. Por favor, espera un momento y vuelve a intentarlo.';
                } else {
                    userFriendlyMessage += ` Detalles: ${error.message}`; // Mensaje genérico con detalles si no es un error conocido
                }
                appendMessage('syncronix', userFriendlyMessage);
            } finally {
                hideTypingIndicator();
                resetStates();
            }
        }

        // --- Manejo de Tareas ---

        // Inicia el flujo para añadir una tarea
        function startAddTask() {
            currentAction = 'addTask';
            pendingDetail = 'description';
            appendMessage('syncronix', '¿Qué tarea te gustaría añadir? Puedes añadir etiquetas con # (ej: "Estudiar para examen de historia #universidad #urgente")');
        }

        // Maneja la descripción y etiquetas de la tarea
        function handleAddTaskDescription(userText) {
            const tags = (userText.match(/#(\w+)/g) || []).map(tag => tag.toLowerCase());
            const descriptionWithoutTags = userText.replace(/#(\w+)/g, '').trim();

            if (!descriptionWithoutTags) {
                appendMessage('syncronix', 'Parece que no escribiste una descripción para la tarea. Por favor, intenta de nuevo.');
                return;
            }

            const newTaskId = tasks.length > 0 ? Math.max(...tasks.map(t => t.id)) + 1 : 1;
            tempTask = { id: newTaskId, description: descriptionWithoutTags, completed: false, tags: tags };
            tasks.push(tempTask);
            saveAllData();
            let tagMessage = tags.length > 0 ? ` con las etiquetas: ${tags.join(', ')}` : '';
            appendMessage('syncronix', `¡Tarea "${tempTask.description}"${tagMessage} añadida a tu lista!`);
            showAlert('Tarea Añadida', `"${tempTask.description}" ha sido agregada.`);
            resetStates();
        }

        // Lista las tareas
        function listTasks() {
            if (tasks.length === 0) {
                appendMessage('syncronix', 'No tienes tareas en tu lista.');
                return;
            }

            let message = 'Aquí está tu lista de tareas:<ul>';
            tasks.forEach(task => {
                const status = task.completed ? '✅' : '⏳';
                const tagsDisplay = task.tags.length > 0 ? ` (${task.tags.map(t => `<span style="color: #00d4ff;">${t}</span>`).join(' ')})` : '';
                message += `<li>${status} <strong>${task.id}.</strong> ${task.description}${tagsDisplay}</li>`;
            });
            message += '</ul>';
            appendMessage('syncronix', message);
            resetStates();
        }

        // Inicia el flujo para completar una tarea
        function startCompleteTask() {
            if (tasks.filter(t => !t.completed).length === 0) {
                appendMessage('syncronix', '¡No tienes tareas pendientes para completar!');
                resetStates();
                return;
            }
            let message = '¿Qué tarea te gustaría marcar como completada? Dime el número o una descripción de la tarea:<ul>';
            tasks.filter(t => !t.completed).forEach(task => {
                message += `<li><strong>${task.id}.</strong> ${task.description}</li>`;
            });
            message += '</ul>';
            appendMessage('syncronix', message);
            currentAction = 'completeTask';
            pendingDetail = 'taskToComplete';
        }

        // Maneja la finalización de una tarea
        function handleCompleteTask(userText) {
            const taskId = parseInt(userText);
            let taskFound = null;

            if (!isNaN(taskId)) {
                taskFound = tasks.find(task => task.id === taskId);
            } else {
                taskFound = tasks.find(task => task.description.toLowerCase().includes(userText.toLowerCase()));
            }

            if (taskFound) {
                taskFound.completed = true;
                saveAllData();
                appendMessage('syncronix', `¡Excelente! Tarea "${taskFound.description}" marcada como completada.`);
                showAlert('Tarea Completada', `¡"${taskFound.description}" completada!`);
            } else {
                appendMessage('syncronix', 'No pude encontrar esa tarea. Por favor, intenta con el número o una descripción exacta.');
            }
            resetStates();
        }

        // Inicia el flujo para eliminar una tarea
        function startDeleteTask() {
            if (tasks.length === 0) {
                appendMessage('syncronix', 'No tienes tareas para eliminar.');
                resetStates();
                return;
            }
            let message = '¿Qué tarea te gustaría eliminar? Dime el número o una descripción de la tarea:<ul>';
            tasks.forEach(task => {
                message += `<li><strong>${task.id}.</strong> ${task.description}</li>`;
            });
            message += '</ul>';
            appendMessage('syncronix', message);
            currentAction = 'deleteTask';
            pendingDetail = 'taskToDelete';
        }

        // Maneja la eliminación de una tarea
        function handleDeleteTask(userText) {
            const taskId = parseInt(userText);
            let taskRemoved = null;

            if (!isNaN(taskId)) {
                const index = tasks.findIndex(task => task.id === taskId);
                if (index !== -1) {
                    taskRemoved = tasks.splice(index, 1)[0];
                }
            } else {
                const index = tasks.findIndex(task => task.description.toLowerCase().includes(userText.toLowerCase()));
                if (index !== -1) {
                    taskRemoved = tasks.splice(index, 1)[0];
                }
            }

            if (taskRemoved) {
                saveAllData();
                appendMessage('syncronix', `La tarea "${taskRemoved.description}" ha sido eliminada.`);
                showAlert('Tarea Eliminada', `"${taskRemoved.description}" ha sido removida.`);
            } else {
                appendMessage('syncronix', 'No pude encontrar esa tarea. Por favor, intenta con el número o una descripción exacta.');
            }
            resetStates();
        }

        // --- Manejo de Contactos ---

        // Inicia el flujo para añadir un contacto
        function startAddContact() {
            currentAction = 'addContact';
            pendingDetail = 'contactName';
            appendMessage('syncronix', 'Claro, ¿cuál es el nombre del contacto?');
        }

        // Maneja los detalles del contacto
        function handleAddContactDetails(userText) {
            switch (pendingDetail) {
                case 'contactName':
                    tempContact.name = userText;
                    pendingDetail = 'contactPhone';
                    appendMessage('syncronix', `¿Cuál es el número de teléfono de ${tempContact.name}?`);
                    break;
                case 'contactPhone':
                    tempContact.phone = userText;
                    pendingDetail = 'contactEmail';
                    appendMessage('syncronix', `¿Cuál es el correo electrónico de ${tempContact.name}? (O escribe 'no' si no tienes uno)`);
                    break;
                case 'contactEmail':
                    tempContact.email = userText.toLowerCase() === 'no' ? '' : userText;
                    contacts.push(tempContact);
                    saveAllData();
                    appendMessage('syncronix', `¡Contacto ${tempContact.name} guardado! Teléfono: ${tempContact.phone}, Email: ${tempContact.email || 'N/A'}.`);
                    showAlert('Contacto Guardado', `¡${tempContact.name} ha sido añadido a tus contactos!`);
                    resetStates();
                    break;
            }
        }

        // Lista todos los contactos
        function listContacts() {
            if (contacts.length === 0) {
                appendMessage('syncronix', 'No tienes contactos guardados.');
                return;
            }

            let message = 'Aquí están tus contactos:<ul>';
            contacts.forEach((contact, index) => {
                message += `<li><strong>${index + 1}.</strong> ${contact.name} - Teléfono: ${contact.phone} - Email: ${contact.email || 'N/A'}</li>`;
            });
            message += '</ul>';
            appendMessage('syncronix', message);
            resetStates();
        }

        // Inicia el flujo para buscar un contacto
        function startFindContact() {
            currentAction = 'findContact';
            pendingDetail = 'contactToFind';
            appendMessage('syncronix', '¿Qué contacto deseas buscar? Dime el nombre completo o parcial.');
        }

        // Maneja la búsqueda de un contacto
        function handleFindContact(userText) {
            const searchTerm = userText.toLowerCase();
            const foundContacts = contacts.filter(contact =>
                contact.name.toLowerCase().includes(searchTerm)
            );

            if (foundContacts.length > 0) {
                let message = `He encontrado ${foundContacts.length} contacto(s) que coinciden:<ul>`;
                foundContacts.forEach(contact => {
                    message += `<li><strong>${contact.name}</strong> - Teléfono: ${contact.phone} - Email: ${contact.email || 'N/A'}</li>`;
                });
                message += '</ul>';
                appendMessage('syncronix', message);
            } else {
                appendMessage('syncronix', `No encontré ningún contacto que coincida con "${userText}".`);
            }
            resetStates();
        }

        // --- 2. Referencias a los elementos del DOM ---
        const chatBox = document.getElementById('chatBox');
        const userInput = document.getElementById('userInput');
        const sendButton = document.getElementById('sendButton');
        const calendarInput = document.getElementById('calendarInput');
        const helpButton = document.getElementById('helpButton');
        const helpModal = document.getElementById('helpModal');
        const closeHelpModal = document.getElementById('closeHelpModal');
        // Separamos las listas de comandos para el modal de ayuda categorizado
        const commandListTime = document.getElementById('commandListTime');
        const commandListTasks = document.getElementById('commandListTasks');
        const commandListContacts = document.getElementById('commandListContacts');
        const commandListResearch = document.getElementById('commandListResearch'); // Nueva categoría
        const commandListGeneral = document.getElementById('commandListGeneral');   // Nueva categoría
        const typingIndicator = document.getElementById('typingIndicator');

        const customAlertModal = document.getElementById('customAlertModal');
        const customAlertTitle = document.getElementById('customAlertTitle');
        const customAlertMessage = document.getElementById('customAlertMessage');
        const customAlertCloseButton = document.getElementById('customAlertCloseButton');

        // --- 3. Variables de estado del chatbot ---
        let userName = '';
        let expectingName = true;

        let currentAction = null;
        let pendingDetail = null;
        let tempEvent = { type: '', date: '', time: '', description: '' };
        let tempTask = { id: null, description: '', completed: false, tags: [] }; // Añadimos tags
        let tempContact = { name: '', phone: '', email: '' };

        // Almacenamiento de datos en localStorage
        let scheduledEvents = JSON.parse(localStorage.getItem('syncronixEvents')) || [];
        let tasks = JSON.parse(localStorage.getItem('syncronixTasks')) || [];
        let contacts = JSON.parse(localStorage.getItem('syncronixContacts')) || [];

        // --- Funciones para manejar la API Key (Tus adiciones) ---
        let apiKey = localStorage.getItem('gemini_api_key') || "";
        let apiKeyModal = document.getElementById('apiKeyModal');
        let apiKeyInput = document.getElementById('apiKeyInput');
        let apiKeySave = document.getElementById('apiKeySave');
        let apiKeyCancel = document.getElementById('apiKeyCancel');

        function showApiKeyModal() {
            apiKeyInput.value = apiKey;
            apiKeyModal.style.display = 'flex';
        }

        function saveApiKey() {
            apiKey = apiKeyInput.value.trim();
            localStorage.setItem('gemini_api_key', apiKey);
            apiKeyModal.style.display = 'none';
            
            if (!apiKey) {
                showAlert('API Key Eliminada', 'La clave API ha sido eliminada. Algunas funciones pueden no estar disponibles.');
            } else {
                showAlert('API Key Guardada', 'La clave API ha sido configurada correctamente.');
            }
        }

        function checkApiKey() {
            if (!apiKey) {
                return false;
            }
            return true;
        }

        // Event listeners para el modal de API Key
        apiKeySave.addEventListener('click', saveApiKey);
        apiKeyCancel.addEventListener('click', () => {
            apiKeyModal.style.display = 'none';
        });

        // Cerrar modal haciendo clic fuera del contenido
        window.addEventListener('click', (event) => {
            if (event.target === apiKeyModal) {
                apiKeyModal.style.display = 'none';
            }
        });

        // --- 4. Función para guardar todos los datos en localStorage ---
        function saveAllData() {
            localStorage.setItem('syncronixEvents', JSON.stringify(scheduledEvents));
            localStorage.setItem('syncronixTasks', JSON.stringify(tasks));
            localStorage.setItem('syncronixContacts', JSON.stringify(contacts));
        }

        // --- 5. Mapeo de comandos a funciones (DEFINIDO EN window.onload) ---
        let commandMap; // Se declara aquí, pero se inicializa en window.onload

        // --- 6. Función principal para procesar el mensaje del usuario ---
        async function processMessage(userText) {
            const lowerCaseText = userText.toLowerCase();

            if (expectingName) {
                userName = userText.split(' ')[0]; // Toma la primera palabra como nombre
                appendMessage('user', userText);
                appendMessage('syncronix', `¡Excelente, ${userName}! Me alegra tenerte aquí. Soy SynCronix, tu asistente personal. Estoy aquí para ayudarte a organizar tus ideas, gestionar tus proyectos académicos o reportajes, y mantener un seguimiento de tus plazos importantes. ¿Qué te gustaría hacer?`);
                expectingName = false;
                userInput.placeholder = "Escribe tu mensaje...";
                resetStates();
                return;
            }

            appendMessage('user', userText);

            // Si hay un flujo guiado pendiente
            if (currentAction && pendingDetail) {
                switch (currentAction) {
                    case 'meeting':
                    case 'alarm':
                    case 'setReminder':
                        handleEventDetails(userText);
                        break;
                    case 'addTask':
                        handleAddTaskDescription(userText);
                        break;
                    case 'completeTask':
                        handleCompleteTask(userText);
                        break;
                    case 'deleteTask':
                        handleDeleteTask(userText);
                        break;
                    case 'cancelEvent':
                        handleCancelEvent(userText);
                        break;
                    case 'addContact':
                        handleAddContactDetails(userText);
                        break;
                    case 'findContact':
                        handleFindContact(userText);
                        break;
                    // Aquí podrías añadir un case para 'saveNote'
                    default:
                        appendMessage('syncronix', 'Hubo un error en el flujo actual. Por favor, intenta de nuevo.');
                        resetStates();
                        break;
                }
                return; // Salir de la función si se está en un flujo guiado
            }

            // Procesar comandos directos si no hay flujo pendiente
            let commandHandled = false;
            for (const command of commandMap) {
                for (const keyword of command.keywords) {
                    if (lowerCaseText.includes(keyword)) {
                        const handlerFunction = window[command.handlerName];
                        if (typeof handlerFunction === 'function') {
                            if (command.args) {
                                handlerFunction(...command.args);
                            } else {
                                handlerFunction();
                            }
                            commandHandled = true;
                            break; // Salir del bucle de keywords
                        } else {
                            console.error(`Error: La función manejadora '${command.handlerName}' no está definida.`);
                            appendMessage('syncronix', 'Lo siento, hubo un problema interno. Por favor, intenta de nuevo.');
                            commandHandled = true; // Considerar manejado para no llamar a Gemini
                            break;
                        }
                    }
                }
                if (commandHandled) break; // Salir del bucle de comandos
            }

            // Si no se entendió ningún comando específico, llamar al LLM
            if (!commandHandled) {
                await callGeminiAPI(userText);
            }
        }

        // --- 7. Manejo de Eventos de la Interfaz de Usuario (UI) ---

        function handleUserInput() {
            const text = userInput.value.trim();
            if (text) {
                processMessage(text);
                userInput.value = '';
            }
        }

        userInput.addEventListener('keypress', (event) => {
            if (event.key === 'Enter') {
                handleUserInput();
            }
        });

        sendButton.addEventListener('click', handleUserInput);

        // --- Lógica del Modal de Ayuda ---

        function populateCommandList() {
            // Limpia todas las listas antes de poblar
            commandListTime.innerHTML = '';
            commandListTasks.innerHTML = '';
            commandListContacts.innerHTML = '';
            commandListResearch.innerHTML = '';
            commandListGeneral.innerHTML = '';

            // Categorías de comandos
            const commandCategories = {
                'time': commandListTime,
                'tasks': commandListTasks,
                'contacts': commandListContacts,
                'research': commandListResearch,
                'general': commandListGeneral
            };

            // Saludo y nombre propio del bot
            const nameHelp = document.createElement('li');
            nameHelp.innerHTML = `Saber mi nombre: Escribe "<strong>cómo te llamas</strong>"`;
            commandListGeneral.appendChild(nameHelp);
            
            // Ayuda general
            const helpCommand = document.createElement('li');
            helpCommand.innerHTML = `Ayuda general: Escribe "<strong>ayuda</strong>" o haz clic en "?"`;
            commandListGeneral.appendChild(helpCommand);


            commandMap.forEach(command => {
                if (command.displayName && command.category) { // Asegúrate de que los comandos tengan una categoría
                    const listItem = document.createElement('li');
                    listItem.innerHTML = `${command.displayName}: Escribe "<strong>${command.keywords[0]}</strong>"`;
                    if (commandCategories[command.category]) {
                        commandCategories[command.category].appendChild(listItem);
                    }
                }
            });
        }

        helpButton.addEventListener('click', () => {
            populateCommandList();
            helpModal.style.display = 'flex';
        });

        closeHelpModal.addEventListener('click', () => {
            helpModal.style.display = 'none';
        });

        window.addEventListener('click', (event) => {
            if (event.target === helpModal) {
                helpModal.style.display = 'none';
            }
        });

        // --- Lógica del Modal de Alerta Personalizado ---
        customAlertCloseButton.addEventListener('click', () => {
            customAlertModal.style.display = 'none';
        });

        // --- Botones de acción rápida (Tus adiciones) ---
        document.getElementById('quickTime').addEventListener('click', () => {
            appendMessage('user', '¿Qué hora es?');
            handleTimeAndDateQuery();
        });

        document.getElementById('quickDate').addEventListener('click', () => {
            appendMessage('user', '¿Qué fecha es hoy?');
            handleTimeAndDateQuery();
        });

        document.getElementById('quickTasks').addEventListener('click', () => {
            appendMessage('user', 'Mostrar mis tareas');
            listTasks();
        });

        document.getElementById('quickEvents').addEventListener('click', () => {
            appendMessage('user', 'Mostrar mis eventos');
            listScheduledEvents();
        });


        // --- 8. Inicialización al cargar la página ---
        window.onload = function() {
            commandMap = [
                { keywords: ['que hora es', 'que fecha es', 'la hora actual', 'la fecha actual', 'quiero saber la hora'], handlerName: 'handleTimeAndDateQuery', displayName: "Preguntar la hora y fecha actual", category: 'time' },
                { keywords: ['agendar reunion', 'programar reunion', 'crear reunion'], handlerName: 'startScheduleEvent', args: ['meeting'], displayName: "Agendar una reunión", category: 'time' },
                { keywords: ['programar alarma', 'agendar alarma', 'poner alarma', 'configurar alarma'], handlerName: 'startScheduleEvent', args: ['alarm'], displayName: "Programar una alarma", category: 'time' },
                { keywords: ['recordatorio', 'pon un recordatorio', 'recuerdame'], handlerName: 'startScheduleEvent', args: ['setReminder'], displayName: "Establecer un recordatorio", category: 'time' },
                { keywords: ['lista eventos', 'muestrame mis eventos', 'que tengo agendado'], handlerName: 'listScheduledEvents', displayName: "Ver mis eventos agendados", category: 'time' },
                { keywords: ['cancelar evento', 'cancelar reunion', 'cancelar alarma'], handlerName: 'startCancelEvent', displayName: "Cancelar un evento agendado", category: 'time' },
                
                { keywords: ['añadir tarea', 'nueva tarea', 'agregar tarea'], handlerName: 'startAddTask', displayName: "Añadir una tarea", category: 'tasks' },
                { keywords: ['lista tareas', 'mis tareas', 'ver tareas'], handlerName: 'listTasks', displayName: "Ver mi lista de tareas", category: 'tasks' },
                { keywords: ['completar tarea', 'tarea completada'], handlerName: 'startCompleteTask', displayName: "Marcar tarea como completada", category: 'tasks' },
                { keywords: ['eliminar tarea', 'borrar tarea'], handlerName: 'startDeleteTask', displayName: "Eliminar una tarea", category: 'tasks' },
                
                { keywords: ['añadir contacto', 'nuevo contacto', 'agregar contacto'], handlerName: 'startAddContact', displayName: "Añadir un contacto", category: 'contacts' },
                { keywords: ['lista contactos', 'mis contactos', 'ver contactos'], handlerName: 'listContacts', displayName: "Ver mi lista de contactos", category: 'contacts' },
                { keywords: ['buscar contacto', 'encontrar contacto'], handlerName: 'startFindContact', displayName: "Buscar un contacto", category: 'contacts' },
                
                // Estos comandos no tienen handlerName propio, confían en callGeminiAPI
                { keywords: ['quien te creo', 'quien te hizo', 'tus creadores'], handlerName: 'handleCreatorsQuery', displayName: "Saber quién me creó", category: 'general' },
                { keywords: ['hola', 'buenos dias', 'buenas tardes', 'buenas noches', 'saludos'], handlerName: 'handleGreeting', displayName: "Saludar al bot", category: 'general' },
                
                // Aquí podrías añadir comandos relacionados con investigación/notas
                // { keywords: ['guardar nota', 'añadir nota'], handlerName: 'startSaveNote', displayName: "Guardar una nota", category: 'research' },
                // { keywords: ['resumir nota', 'resumen de nota'], handlerName: "Resumir una nota", category: 'research' },
                // { keywords: ['ideas para', 'brainstorming'], handlerName: "Generar ideas", category: 'research' },
            ];

            initialGreeting(); // Iniciar el saludo y el chat

            // Añadir evento al botón de ayuda para incluir opción de API Key
            helpButton.addEventListener('click', () => {
                populateCommandList();
                
                // Añadir opción para configurar API Key en la sección general
                const apiKeyItem = document.createElement('li');
                apiKeyItem.innerHTML = `<strong>Configurar API Key</strong>: Haz clic <a href="#" id="configApiKey">aquí</a> para configurar tu clave API de Gemini.`;
                commandListGeneral.appendChild(apiKeyItem); // Añadido a la sección general
                
                document.getElementById('configApiKey').addEventListener('click', (e) => {
                    e.preventDefault();
                    helpModal.style.display = 'none';
                    showApiKeyModal();
                });
                
                helpModal.style.display = 'flex';
            });

            // Verificar API Key al inicio
            if (!apiKey) {
                setTimeout(() => {
                    showAlert('Configuración Requerida', 'Para usar todas las funciones, especialmente las respuestas avanzadas, necesitas configurar una clave API de Gemini.');
                    showApiKeyModal();
                }, 2000);
            }
        };
    </script>
</body>
</html>
